<!DOCTYPE html>
<script src="/jsx.transformer.js"></script>
<script src="/react.js"></script>
<script src="/timbre.dev.js"></script>
<script src="rx.all.js"></script>
<div id="app"></div>
<script type='text/jsx'>
// a1 -> a2 arc counter-clockwise
function arc(x, y, r, a1, a2) {
  var a1r = a1 * Math.PI / 180.0
  var a2r = a2 * Math.PI / 180.0
  while (a2r < a1r) a2r = a2r + 2 * Math.PI
  return [
    'M', x + (r * Math.cos(a1r)), y - (r * Math.sin(a1r)),
    'A', r, r, 0,
    a2r - a1r < Math.PI ? '0' : '1', // large arc?
    0, // counter-clockwise never take the sweep
    x + (r * Math.cos(a2r)), y - (r * Math.sin(a2r))
  ].join(' ')
}
function valueArc(x, y, r, min, max, vp) {
  var valueAngle = min + (max - min) * vp
  var midAngle = min + (max - min) * 0.5
  if (vp < 0.5) {
    return arc(x, y, r, midAngle, valueAngle)
  }
  return arc(x, y, r, valueAngle, midAngle)
}
var Knob = React.createClass({
  componentDidMount: function() {
    var self = this
    var mouseup   = Rx.Observable.fromEvent(document,          'mouseup')
    var mousemove = Rx.Observable.fromEvent(document,          'mousemove')
    var mousedown = Rx.Observable.fromEvent(this.getDOMNode(), 'mousedown')
    var ydrag     = mousedown.flatMap(function (md) {
      var startY = md.clientY
      var startValue = self.props.value
      return mousemove.map(function (mm) {
        mm.preventDefault()
        var dy = mm.clientY - startY
        return Math.floor(-dy / 3) * self.props.step + startValue
      }).takeUntil(mouseup)
    })
    this.subscription = ydrag.subscribe(function (v) {
      self.props.onChange(v)
    })
  },
  componentWillUnmount: function() {
    this.subscription.dispose()
  },
  getDefaultProps: function() {
    // props: min, max, step = 1
    return {
      minAngle: 270, // degrees
      maxAngle: 0
    }
  },
  render: function() {
    var value = Math.max(this.props.min, Math.min(this.props.max, this.props.value))
    var valuep = value / (this.props.max - this.props.min)
    //<path d={describeArc(50, 50, 45, this.props.start, this.props.end)} fill="transparent" stroke="black" strokeWidth="5" />
    return <svg width="40px" height="40px" viewBox="0 0 100 100" version="1.1" xmlns="http://www.w3.org/2000/svg" >
      <path d={arc(50, 50, 45, true, this.props.minAngle, this.props.maxAngle)} fill="transparent" stroke="#3B3C40" strokeWidth="5" strokeLinecap="round" />
      <path d={valueArc(50, 50, 45, this.props.minAngle, this.props.maxAngle, valuep)} fill="transparent" stroke="#FC7E63" strokeWidth="5" strokeLinecap="round" />
    </svg>
  }
})

var Soundboard = React.createClass({
  componentDidMount: function() {
    this.osc = T("sin", {freq:this.state.freq, mul:0.25})
    this.osc.play()
  },
  componentDidUpdate: function() {
    this.osc.freq = this.state.freq
  },
  getInitialState: function() {
    return {
      freq: 528.32,
      semitone: 0
    }
  },
  onFreqChange: function(freq) {
    this.setState({freq: freq})
  },
  onSemitoneChange: function(semitone) {
    this.setState({semitone: semitone})
  },
  render: function() {
    return <div>
      <Knob value={this.state.freq} min="500" max="20000" step="100" onChange={this.onFreqChange} />
      <Knob value={this.state.semitone} min="0" max="3" step="1" onChange={this.onSemitoneChange} />
    </div>
  }
})

React.render(
  <Soundboard />,
  document.getElementById('app')
)
</script>
