<!DOCTYPE html>
<script src="/jsx.transformer.js"></script>
<script src="/react.js"></script>
<script src="/rx.all.js"></script>
<script>
var keydowns = Rx.Observable.fromEvent(document, 'keydown')
var keyups   = Rx.Observable.fromEvent(document, 'keyup')

function isKeyboardKey(keyCode) {
  'awsedftgyhujkolp;'
}

var chords = Rx.Observable.merge(
  keydowns.map(function(e) {
    return {t: 'keydown', e: e}
  }),
  keyups.map(function(e) {
    return {t: 'keyup', e: e}
  })
).scan([], function(keys, e) {
  var keyCode = e.e.keyCode
  var i
  if (e.t == 'keydown' && keys.indexOf(keyCode) == -1) {
    keys = keys.concat([keyCode])
  } else if (e.t == 'keyup' && (i = keys.indexOf(keyCode)) != -1) {
    keys = keys.slice(0, i).concat(keys.slice(i+1))
  }
  if (keys.length > 5) {
    keys = keys.slice(1)
  }
  return keys
}).distinctUntilChanged()

var audioCtx = new (window.AudioContext || window.webkitAudioContext)()
var voices = {}
chords.subscribe(function(keys) {
  // remove dead voices
  Object.keys(voices).map(function(x) {
    return parseInt(x, 10)
  }).forEach(function(key) {
    if (keys.indexOf(key) == -1) {
      voices[key].stop()
      delete voices[key]
    }
  })
  // add new voices
  keys.forEach(function(key) {
    if (!voices[key]) {
      var oscillator = audioCtx.createOscillator()
      oscillator.type = 'square'
      oscillator.frequency.value = 440 + key // value in hertz
      oscillator.start()
      oscillator.connect(audioCtx.destination)
      voices[key] = oscillator
    }
  })

})
</script>
